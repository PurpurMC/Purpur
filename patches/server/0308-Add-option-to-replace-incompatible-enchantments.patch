From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: MelnCat <melncatuwu@gmail.com>
Date: Wed, 23 Aug 2023 13:11:08 -0700
Subject: [PATCH] Add option to replace incompatible enchantments


diff --git a/src/main/java/net/minecraft/world/inventory/AnvilMenu.java b/src/main/java/net/minecraft/world/inventory/AnvilMenu.java
index cb4a1cd39f12d90d30dd95efa2de58f57d9c6ee0..531b911c1bcdd3735529ee18f2bb0ccdf4ad6089 100644
--- a/src/main/java/net/minecraft/world/inventory/AnvilMenu.java
+++ b/src/main/java/net/minecraft/world/inventory/AnvilMenu.java
@@ -242,6 +242,10 @@ public class AnvilMenu extends ItemCombinerMenu {
 
                                 if (enchantment1 != enchantment && !enchantment.isCompatibleWith(enchantment1)) {
                                     flag4 = canDoUnsafeEnchants || (org.purpurmc.purpur.PurpurConfig.allowUnsafeEnchants && org.purpurmc.purpur.PurpurConfig.allowIncompatibleEnchants); // Purpur flag3 -> flag4
+                                    if (!flag4 && org.purpurmc.purpur.PurpurConfig.replaceIncompatibleEnchants) {
+                                        iterator1.remove();
+                                        flag4 = true;
+                                    }
                                     ++i;
                                 }
                             }
diff --git a/src/main/java/org/purpurmc/purpur/PurpurConfig.java b/src/main/java/org/purpurmc/purpur/PurpurConfig.java
index 3029f38cff6755b31427efb7fae3b6886ee8e4ee..337333a92234e4735aa20c7af400f12eb1f55b28 100644
--- a/src/main/java/org/purpurmc/purpur/PurpurConfig.java
+++ b/src/main/java/org/purpurmc/purpur/PurpurConfig.java
@@ -423,6 +423,7 @@ public class PurpurConfig {
     public static boolean allowHigherEnchantsLevels = true;
     public static boolean allowUnsafeEnchantCommand = false;
     public static boolean clampEnchantLevels = true;
+    public static boolean replaceIncompatibleEnchants = false;
     private static void enchantmentSettings() {
         if (version < 5) {
             boolean oldValue = getBoolean("settings.enchantment.allow-infinite-and-mending-together", false);
@@ -446,6 +447,7 @@ public class PurpurConfig {
         allowHigherEnchantsLevels = getBoolean("settings.enchantment.anvil.allow-higher-enchants-levels", allowHigherEnchantsLevels);
         allowUnsafeEnchantCommand = getBoolean("settings.enchantment.allow-unsafe-enchant-command", allowUnsafeEnchants); // allowUnsafeEnchants as default for backwards compatability
         clampEnchantLevels = getBoolean("settings.enchantment.clamp-levels", clampEnchantLevels);
+        replaceIncompatibleEnchants = getBoolean("settings.enchantment.anvil.replace-incompatible-enchants", replaceIncompatibleEnchants);
     }
 
     public static boolean endermanShortHeight = false;
