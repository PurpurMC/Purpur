From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: 12emin34 <macanovic.emin@gmail.com>
Date: Sat, 12 Feb 2022 01:08:18 +0100
Subject: [PATCH] Anvil repair/damage options


diff --git a/src/main/java/net/minecraft/world/level/block/AnvilBlock.java b/src/main/java/net/minecraft/world/level/block/AnvilBlock.java
index 61cadc946954a1e92bd9b395b87dcb83eef786c4..aaa4aa929140a7e0630360caa3195a9264006e16 100644
--- a/src/main/java/net/minecraft/world/level/block/AnvilBlock.java
+++ b/src/main/java/net/minecraft/world/level/block/AnvilBlock.java
@@ -15,6 +15,7 @@ import net.minecraft.world.entity.item.FallingBlockEntity;
 import net.minecraft.world.entity.player.Player;
 import net.minecraft.world.inventory.AnvilMenu;
 import net.minecraft.world.inventory.ContainerLevelAccess;
+import net.minecraft.world.item.Items;
 import net.minecraft.world.item.context.BlockPlaceContext;
 import net.minecraft.world.level.BlockGetter;
 import net.minecraft.world.level.Level;
@@ -55,6 +56,33 @@ public class AnvilBlock extends FallingBlock {
 
     @Override
     public InteractionResult use(BlockState state, Level world, BlockPos pos, Player player, InteractionHand hand, BlockHitResult hit) {
+        // Purpur start - repairable/damageable anvils
+        if (player.getItemInHand(hand).is(Items.IRON_INGOT) && world.purpurConfig.anvilCanRepairUsingIngots) {
+            if (state.is(Blocks.DAMAGED_ANVIL)) {
+                world.setBlock(pos, Blocks.CHIPPED_ANVIL.defaultBlockState().setValue(FACING, state.getValue(FACING)), 2);
+                if (!player.getAbilities().instabuild) player.getItemInHand(hand).shrink(1);
+                return InteractionResult.CONSUME;
+            } else if (state.is(Blocks.CHIPPED_ANVIL)) {
+                world.setBlock(pos, Blocks.ANVIL.defaultBlockState().setValue(FACING, state.getValue(FACING)), 2);
+                if (!player.getAbilities().instabuild) player.getItemInHand(hand).shrink(1);
+                return InteractionResult.CONSUME;
+            }
+        } else if (player.getItemInHand(hand).is(Items.OBSIDIAN) && world.purpurConfig.anvilCanDamageUsingObsidian) {
+            if (state.is(Blocks.DAMAGED_ANVIL)) {
+                world.destroyBlock(pos, false);
+                if (!player.getAbilities().instabuild) player.getItemInHand(hand).shrink(1);
+                return InteractionResult.CONSUME;
+            } else if (state.is(Blocks.CHIPPED_ANVIL)) {
+                world.setBlock(pos, Blocks.DAMAGED_ANVIL.defaultBlockState().setValue(FACING, state.getValue(FACING)), 2);
+                if (!player.getAbilities().instabuild) player.getItemInHand(hand).shrink(1);
+                return InteractionResult.CONSUME;
+            } else if (state.is(Blocks.ANVIL)) {
+                world.setBlock(pos, Blocks.CHIPPED_ANVIL.defaultBlockState().setValue(FACING, state.getValue(FACING)), 2);
+                if (!player.getAbilities().instabuild) player.getItemInHand(hand).shrink(1);
+                return InteractionResult.CONSUME;
+            }
+        }
+        // Purpur end
         if (world.isClientSide) {
             return InteractionResult.SUCCESS;
         } else {
diff --git a/src/main/java/org/purpurmc/purpur/PurpurWorldConfig.java b/src/main/java/org/purpurmc/purpur/PurpurWorldConfig.java
index 7c131da608b91555cd5293da5b90de0ee9c10f9e..101e949555b309f10e466ffe475bf40db565465b 100644
--- a/src/main/java/org/purpurmc/purpur/PurpurWorldConfig.java
+++ b/src/main/java/org/purpurmc/purpur/PurpurWorldConfig.java
@@ -699,8 +699,12 @@ public class PurpurWorldConfig {
     }
 
     public boolean anvilAllowColors = false;
+    public boolean anvilCanRepairUsingIngots = false;
+    public boolean anvilCanDamageUsingObsidian = false;
     private void anvilSettings() {
         anvilAllowColors = getBoolean("blocks.anvil.allow-colors", anvilAllowColors);
+        anvilCanRepairUsingIngots = getBoolean("blocks.anvil.repair-with-iron-ingots", anvilCanRepairUsingIngots);
+        anvilCanDamageUsingObsidian = getBoolean("blocks.anvil.damage-with-obsidian", anvilCanDamageUsingObsidian);
     }
 
     public double azaleaGrowthChance = 0.0D;
