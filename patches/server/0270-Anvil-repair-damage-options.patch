From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: 12emin34 <macanovic.emin@gmail.com>
Date: Sat, 12 Feb 2022 01:08:18 +0100
Subject: [PATCH] Anvil repair/damage options


diff --git a/src/main/java/net/minecraft/world/level/block/AnvilBlock.java b/src/main/java/net/minecraft/world/level/block/AnvilBlock.java
index 61cadc946954a1e92bd9b395b87dcb83eef786c4..25af1626aa363bfd8b604b4aba38f8993e85de78 100644
--- a/src/main/java/net/minecraft/world/level/block/AnvilBlock.java
+++ b/src/main/java/net/minecraft/world/level/block/AnvilBlock.java
@@ -55,6 +55,30 @@ public class AnvilBlock extends FallingBlock {
 
     @Override
     public InteractionResult use(BlockState state, Level world, BlockPos pos, Player player, InteractionHand hand, BlockHitResult hit) {
+        // Purpur start - repairable/damageable anvils
+        if (world.purpurConfig.anvilRepairIngotsAmount > 0 && player.getItemInHand(hand).is(net.minecraft.world.item.Items.IRON_INGOT) && player.getItemInHand(hand).getCount() >= world.purpurConfig.anvilRepairIngotsAmount) {
+            if (state.is(Blocks.DAMAGED_ANVIL)) {
+                world.setBlock(pos, Blocks.CHIPPED_ANVIL.defaultBlockState().setValue(FACING, state.getValue(FACING)), 2);
+            } else if (state.is(Blocks.CHIPPED_ANVIL)) {
+                world.setBlock(pos, Blocks.ANVIL.defaultBlockState().setValue(FACING, state.getValue(FACING)), 2);
+            }
+            if (!player.getAbilities().instabuild && !state.is(Blocks.ANVIL))
+                player.getItemInHand(hand).shrink(world.purpurConfig.anvilRepairIngotsAmount);
+            world.playSound(null, pos, net.minecraft.sounds.SoundEvents.ANVIL_PLACE, net.minecraft.sounds.SoundSource.BLOCKS, 1.0F, 1.0F);
+            return InteractionResult.CONSUME;
+        } else if (world.purpurConfig.anvilCanDamageUsingObsidian && player.getItemInHand(hand).is(net.minecraft.world.item.Items.OBSIDIAN)) {
+            if (state.is(Blocks.DAMAGED_ANVIL)) {
+                world.destroyBlock(pos, false);
+            } else if (state.is(Blocks.CHIPPED_ANVIL)) {
+                world.setBlock(pos, Blocks.DAMAGED_ANVIL.defaultBlockState().setValue(FACING, state.getValue(FACING)), 2);
+            } else if (state.is(Blocks.ANVIL)) {
+                world.setBlock(pos, Blocks.CHIPPED_ANVIL.defaultBlockState().setValue(FACING, state.getValue(FACING)), 2);
+            }
+            if (!player.getAbilities().instabuild) player.getItemInHand(hand).shrink(1);
+            world.playSound(null, pos, net.minecraft.sounds.SoundEvents.ANVIL_LAND, net.minecraft.sounds.SoundSource.BLOCKS, 1.0F, 1.0F);
+            return InteractionResult.CONSUME;
+        }
+        // Purpur end
         if (world.isClientSide) {
             return InteractionResult.SUCCESS;
         } else {
diff --git a/src/main/java/org/purpurmc/purpur/PurpurWorldConfig.java b/src/main/java/org/purpurmc/purpur/PurpurWorldConfig.java
index 7c131da608b91555cd5293da5b90de0ee9c10f9e..b37fa8b2347b38e4c5054216d0176f355b546d2e 100644
--- a/src/main/java/org/purpurmc/purpur/PurpurWorldConfig.java
+++ b/src/main/java/org/purpurmc/purpur/PurpurWorldConfig.java
@@ -699,8 +699,12 @@ public class PurpurWorldConfig {
     }
 
     public boolean anvilAllowColors = false;
+    public int anvilRepairIngotsAmount = 0;
+    public boolean anvilCanDamageUsingObsidian = false;
     private void anvilSettings() {
         anvilAllowColors = getBoolean("blocks.anvil.allow-colors", anvilAllowColors);
+        anvilRepairIngotsAmount = getInt("blocks.anvil.iron-ingots-used-for-repair", anvilRepairIngotsAmount);
+        anvilCanDamageUsingObsidian = getBoolean("blocks.anvil.damage-with-obsidian", anvilCanDamageUsingObsidian);
     }
 
     public double azaleaGrowthChance = 0.0D;
