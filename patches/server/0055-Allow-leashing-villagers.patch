From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: William Blake Galbreath <blake.galbreath@gmail.com>
Date: Thu, 3 Oct 2019 18:08:03 -0500
Subject: [PATCH] Allow leashing villagers


diff --git a/src/main/java/net/minecraft/world/entity/Mob.java b/src/main/java/net/minecraft/world/entity/Mob.java
index ecd0556a69eb4b4ef78e3c16e1199fa183047797..c61e6cdcc38524f751f60ac7388de44fb65dcb4a 100644
--- a/src/main/java/net/minecraft/world/entity/Mob.java
+++ b/src/main/java/net/minecraft/world/entity/Mob.java
@@ -1246,6 +1246,7 @@ public abstract class Mob extends LivingEntity {
         if (!this.isAlive()) {
             return InteractionResult.PASS;
         } else if (this.getLeashHolder() == player) {
+            if (hand == InteractionHand.OFF_HAND && (level.purpurConfig().mobs.villager.canBeLeashed || level.purpurConfig().mobs.wanderingTrader.canBeLeashed) && this instanceof net.minecraft.world.entity.npc.AbstractVillager) return InteractionResult.CONSUME; // Purpur
             // CraftBukkit start - fire PlayerUnleashEntityEvent
             // Paper start - drop leash variable
             org.bukkit.event.player.PlayerUnleashEntityEvent event = CraftEventFactory.callPlayerUnleashEntityEvent(this, player, !player.getAbilities().instabuild);
diff --git a/src/main/java/net/minecraft/world/entity/npc/Villager.java b/src/main/java/net/minecraft/world/entity/npc/Villager.java
index cc260f74dc4608128655bc6ac13609e341a0aabc..2b51a2ed4cb79e3e57197825dc7ae5f482d41c07 100644
--- a/src/main/java/net/minecraft/world/entity/npc/Villager.java
+++ b/src/main/java/net/minecraft/world/entity/npc/Villager.java
@@ -181,6 +181,11 @@ public class Villager extends AbstractVillager implements ReputationEventHandler
     public void initAttributes() {
         this.getAttribute(Attributes.MAX_HEALTH).setBaseValue(this.level.purpurConfig().mobs.villager.attributes.maxHealth);
     }
+
+    @Override
+    public boolean canBeLeashed(Player player) {
+        return level.purpurConfig().mobs.villager.canBeLeashed && !this.isLeashed();
+    }
     // Purpur end
 
     @Override
diff --git a/src/main/java/net/minecraft/world/entity/npc/WanderingTrader.java b/src/main/java/net/minecraft/world/entity/npc/WanderingTrader.java
index 44b40576c542093fe2d42520499fc54c41238fab..2158200ab4b3ee39c8909d42545077117775904d 100644
--- a/src/main/java/net/minecraft/world/entity/npc/WanderingTrader.java
+++ b/src/main/java/net/minecraft/world/entity/npc/WanderingTrader.java
@@ -86,6 +86,11 @@ public class WanderingTrader extends net.minecraft.world.entity.npc.AbstractVill
     public void initAttributes() {
         this.getAttribute(net.minecraft.world.entity.ai.attributes.Attributes.MAX_HEALTH).setBaseValue(this.level.purpurConfig().mobs.wanderingTrader.attributes.maxHealth);
     }
+
+    @Override
+    public boolean canBeLeashed(Player player) {
+        return level.purpurConfig().mobs.wanderingTrader.canBeLeashed && !this.isLeashed();
+    }
     // Purpur end
 
     @Override
diff --git a/src/main/java/org/purpurmc/purpur/configuration/PurpurWorldConfiguration.java b/src/main/java/org/purpurmc/purpur/configuration/PurpurWorldConfiguration.java
index 2091e2a5d27ffec30cd5f0dcd7c0554fe98f356f..27e69501e9256dd5641cfb3128ef0f4243453e49 100644
--- a/src/main/java/org/purpurmc/purpur/configuration/PurpurWorldConfiguration.java
+++ b/src/main/java/org/purpurmc/purpur/configuration/PurpurWorldConfiguration.java
@@ -1074,6 +1074,7 @@ public class PurpurWorldConfiguration extends ConfigurationPart {
         public Villager villager;
         public class Villager extends ConfigurationPart {
             public boolean followEmeraldBlock = false;
+            public boolean canBeLeashed = false;
 
             public Ridable ridable;
             public class Ridable extends ConfigurationPart {
@@ -1112,6 +1113,7 @@ public class PurpurWorldConfiguration extends ConfigurationPart {
         public WanderingTrader wanderingTrader;
         public class WanderingTrader extends ConfigurationPart {
             public boolean followEmeraldBlock = false;
+            public boolean canBeLeashed = false;
 
             public Ridable ridable;
             public class Ridable extends ConfigurationPart {
